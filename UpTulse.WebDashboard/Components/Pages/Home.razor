@page "/"
@rendermode InteractiveServer

@using ItTechnologies.CoreUI.Areas.Enums
@using System.Net.ServerSentEvents
@using UpTulse.Application.Models
@using UpTulse.WebDashboard.EnvironmentVariables

@inject IJSRuntime JS
@implements IDisposable

<PageTitle>Home</PageTitle>

@foreach (var message in Messages)
{
    <ItCard>
        <ItText Style="ItTextStyle.CardTitle" Text="@message" />
    </ItCard>
}

@code {
    private readonly List<string> Messages = new();
    private DotNetObjectReference<Home>? objRef;

    protected override async Task OnInitializedAsync()
    {
        objRef = DotNetObjectReference.Create(this);
        try
        {
            await JS.InvokeVoidAsync("sseHandlers.connect", objRef, Environment.GetEnvironmentVariable(SystemEnv.SERVER_URL) ?? string.Empty);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"JS Error: {ex.Message}");
        }
    }

    [JSInvokable]
    public async Task ReceiveMessage(string data)
    {
        if (!string.IsNullOrEmpty(data))
        {
            await InvokeAsync(() =>
            {
                Messages.Add(data);
                StateHasChanged();
            });
        }
    }

    public void Dispose() => objRef?.Dispose();
}